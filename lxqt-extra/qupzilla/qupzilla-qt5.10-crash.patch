From c894e8bb7de834afb1ef3c402966a1ca8950b1ae Mon Sep 17 00:00:00 2001
From: David Rosca <nowrep@gmail.com>
Date: Mon, 23 Oct 2017 16:03:15 +0200
Subject: [PATCH] IconProvider: Use SqlDatabase to exec query on correct
 database in imageForDomain

Fixes crash when being called from multiple threads with Qt 5.10

Closes #2491
---
 src/lib/tools/iconprovider.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/lib/tools/iconprovider.cpp b/src/lib/tools/iconprovider.cpp
index 27b5c865a..4afa2b01e 100644
--- a/src/lib/tools/iconprovider.cpp
+++ b/src/lib/tools/iconprovider.cpp
@@ -1,6 +1,6 @@
 /* ============================================================
-* QupZilla - WebKit based browser
-* Copyright (C) 2010-2016  David Rosca <nowrep@gmail.com>
+* QupZilla - Qt web browser
+* Copyright (C) 2010-2017 David Rosca <nowrep@gmail.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
@@ -225,7 +225,7 @@ QImage IconProvider::imageForDomain(const QUrl &url, bool allowNull)
     query.prepare(QSL("SELECT icon FROM icons WHERE url GLOB ? LIMIT 1"));
 
     query.addBindValue(QString("*%1*").arg(QzTools::escapeSqlGlobString(url.host())));
-    query.exec();
+    SqlDatabase::instance()->exec(query);
 
     if (query.next()) {
         return QImage::fromData(query.value(0).toByteArray());
